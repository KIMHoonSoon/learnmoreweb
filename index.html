<!DOCTYPE html>
<html>
<head>
    <title>TM4MCU</title>
    <style>
        #canvas {
            border: 1px solid black;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script src="bluetoothConnection.js"></script>
</head>
<body>
    <h1 style="font-size:30px;">Teachable Image Model for Microbit</h1>
    <label for="model-url-input">Teachable Machine Image Model URL:</label>
    <input type="text" id="model-url-input" placeholder="Enter your model URL here" >
    <br>
    <button type="button" onclick="setModelUrl()">Set Model URL</button>
    <span id="model-url-display"></span>
    <br>
    <label for="prediction-input">Prediction Value (0 - 100):</label>
    <input type="text" id="prediction-input">
    <br>
    <button type="button" onclick="setPredictionValue()">Set Prediction Value</button>
    <span id="prediction-display"></span>
    <br>
    <button id="connect-to-serial" type="button">Connect to WebSerial</button>
    <button id="disconnect-serial" type="button">Disconnect from WebSerial</button>
    <br>
    <label for="width-input">Canvas Width:</label>
    <input type="number" id="width-input">
    <br>
    <label for="height-input">Canvas Height:</label>
    <input type="number" id="height-input">
    <br>
    <label for="flip-webcam">Flip Webcam:</label>
    <input type="checkbox" id="flip-webcam">
    <br>
    <label for="webcam-select">Select Webcam:</label>
    <select id="webcam-select" onchange="changeSelectedWebcam()"></select>
    <br>
    <button type="button" onclick="changeCanvasSize()">Size Apply</button>
    <button type="button" onclick="setupWebcam()">Change Webcam</button>
    <button type="button" onclick="stopWebcam()">Stop Webcam</button>
    <br>
    <canvas id="canvas"></canvas>
    <br>
    <button type="button" onclick="loadModel()">Load Model</button>
    <button type="button" onclick="init()" id="start-button">Start Teachable Machine</button>
    <div id="label-container" style="font-size:20px;"></div>
    <div id="lastSentClassContainer">Last Sent Class: <span id="lastSentClass">None</span></div>
    <div id="classNameContainer">Current Class: <span id="className">None</span></div>
    <br>
    <script>
        let webcam = null;
        let canvasWidth = 300;
        let canvasHeight = 300;
        let model, labelContainer, maxPredictions;
        let URL = "";
        let selectedWebcamId = "";
        let videoDevices = [];
        let predictionValue = 0;
        let port;

        async function loadModel() {
            if (!URL) {
                alert('Please enter a model URL');
                return;
            }
            try {
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                await tmImage.load(modelURL, metadataURL);
                document.getElementById("start-button").disabled = false;
            } catch (error) {
                alert('Failed to load the model. Please check the URL and try again.');
            }
        }

        function setModelUrl() {
            const modelUrlInput = document.getElementById('model-url-input');
            URL = modelUrlInput.value;
            const modelUrlDisplay = document.getElementById('model-url-display');
            modelUrlDisplay.textContent = `Model URL: ${URL}`;
        }

        function setPredictionValue() {
            const predictionInput = document.getElementById('prediction-input');
            predictionValue = parseFloat(predictionInput.value);
            const predictionDisplay = document.getElementById('prediction-display');
            predictionDisplay.textContent = `Prediction Value: ${predictionValue}`;
        }

        async function init() {
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            model = await tmImage.load(modelURL, metadataURL);
            maxPredictions = model.getTotalClasses();

            const flip = document.getElementById('flip-webcam').checked;

            if (webcam && webcam.stop) {
                webcam.stop();
            }

            webcam = new tmImage.Webcam(canvasWidth, canvasHeight, flip);
            await webcam.setup({deviceId: selectedWebcamId});
            await webcam.play();
            window.requestAnimationFrame(loop);

            labelContainer = document.getElementById("label-container");
            for (let i = 0; i < maxPredictions; i++) {
                labelContainer.appendChild(document.createElement("div"));
            }
            console.log("Teachable Machine initialized");
        }

        async function predict() {
            const prediction = await model.predict(webcam.canvas);
            let max = 0, imax = -1;
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className + ": " + prediction[i].probability.toFixed(2);
                const conf = Math.round(Number(prediction[i].probability.toFixed(2)) * 10000) / 100;
                if (conf > max) {
                    max = conf;
                    imax = i;
                }
            }

            if (max > predictionValue && imax >= 0) {
                let classN = prediction[imax].className;
                if (classN !== lastSentClass) {
                    if (port && port.writable) {
                        const writer = port.writable.getWriter();
                        const data = new TextEncoder().encode(classN);
                        await writer.write(data);
                        writer.releaseLock();
                        document.getElementById("lastSentClass").textContent = classN;
                        document.getElementById("className").textContent = classN;
                        lastSentClass = classN;
                    }
                }
            }
            console.log("Prediction: " + max + ", Class: " + prediction[imax].className);
        }

        async function loop() {
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        document.getElementById('connect-to-serial').addEventListener('click', async () => {
            if ('serial' in navigator) {
                try {
                    port = await navigator.serial.requestPort();
                    await port.open({ baudRate: 115200 });
                    alert('Connected to Micro:bit');
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                console.error('Web Serial API not supported.');
            }
        });

        document.getElementById('disconnect-serial').addEventListener('click', async () => {
            if (port && port.close) {
                await port.close();
                port = null;
                alert('Disconnected from Micro:bit');
            }
        });
    </script>
</body>
</html>
